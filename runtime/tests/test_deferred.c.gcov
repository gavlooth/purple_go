        -:    0:Source:test_deferred.c
        -:    0:Graph:./run_tests_cov-test_main.gcno
        -:    0:Data:./run_tests_cov-test_main.gcda
        -:    0:Runs:1
        -:    1:/* test_deferred.c - Deferred reference counting tests */
        -:    2:#include "test_framework.h"
        -:    3:
        -:    4:/* ========== Deferred Context Tests ========== */
        -:    5:
function test_deferred_ctx_initial called 1 returned 100% blocks executed 42%
        1:    6:void test_deferred_ctx_initial(void) {
       1*:    7:    ASSERT_NULL(DEFERRED_CTX.pending);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
       1*:    8:    ASSERT_EQ(DEFERRED_CTX.pending_count, 0);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
       1*:    9:    ASSERT(DEFERRED_CTX.batch_size > 0);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        1:   10:    PASS();
call    0 returned 1
        -:   11:}
        -:   12:
function test_set_deferred_batch_size called 1 returned 100% blocks executed 62%
        1:   13:void test_set_deferred_batch_size(void) {
        1:   14:    int old_size = DEFERRED_CTX.batch_size;
        1:   15:    set_deferred_batch_size(100);
call    0 returned 1
       1*:   16:    ASSERT_EQ(DEFERRED_CTX.batch_size, 100);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        1:   17:    set_deferred_batch_size(old_size);  /* Restore */
call    0 returned 1
        1:   18:    PASS();
call    0 returned 1
        -:   19:}
        -:   20:
function test_set_deferred_batch_size_zero called 1 returned 100% blocks executed 57%
        1:   21:void test_set_deferred_batch_size_zero(void) {
        1:   22:    int old_size = DEFERRED_CTX.batch_size;
        1:   23:    set_deferred_batch_size(0);  /* Should be ignored */
call    0 returned 1
       1*:   24:    ASSERT_EQ(DEFERRED_CTX.batch_size, old_size);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        1:   25:    PASS();
call    0 returned 1
        -:   26:}
        -:   27:
function test_set_deferred_batch_size_negative called 1 returned 100% blocks executed 57%
        1:   28:void test_set_deferred_batch_size_negative(void) {
        1:   29:    int old_size = DEFERRED_CTX.batch_size;
        1:   30:    set_deferred_batch_size(-10);  /* Should be ignored */
call    0 returned 1
       1*:   31:    ASSERT_EQ(DEFERRED_CTX.batch_size, old_size);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        1:   32:    PASS();
call    0 returned 1
        -:   33:}
        -:   34:
        -:   35:/* ========== defer_decrement Tests ========== */
        -:   36:
function test_defer_decrement_single called 1 returned 100% blocks executed 75%
        1:   37:void test_defer_decrement_single(void) {
        1:   38:    flush_deferred();  /* Clear any pending */
call    0 returned 1
        1:   39:    Obj* obj = mk_int(42);
call    0 returned 1
        1:   40:    inc_ref(obj);  /* Extra ref to prevent immediate free */
call    0 returned 1
        -:   41:
        1:   42:    int old_count = DEFERRED_CTX.pending_count;
        1:   43:    defer_decrement(obj);
call    0 returned 1
       1*:   44:    ASSERT_EQ(DEFERRED_CTX.pending_count, old_count + 1);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        -:   45:
        1:   46:    flush_deferred();
call    0 returned 1
        1:   47:    dec_ref(obj);  /* Clean up extra ref */
call    0 returned 1
        1:   48:    PASS();
call    0 returned 1
        -:   49:}
        -:   50:
function test_defer_decrement_null called 1 returned 100% blocks executed 57%
        1:   51:void test_defer_decrement_null(void) {
        1:   52:    int old_count = DEFERRED_CTX.total_deferred;
        1:   53:    defer_decrement(NULL);
call    0 returned 1
       1*:   54:    ASSERT_EQ(DEFERRED_CTX.total_deferred, old_count);  /* Unchanged */
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        1:   55:    PASS();
call    0 returned 1
        -:   56:}
        -:   57:
function test_deferred_coalesce_same_obj called 1 returned 100% blocks executed 80%
        1:   58:void test_deferred_coalesce_same_obj(void) {
        1:   59:    flush_deferred();
call    0 returned 1
        1:   60:    Obj* obj = mk_int(42);
call    0 returned 1
        1:   61:    inc_ref(obj);
call    0 returned 1
        1:   62:    inc_ref(obj);
call    0 returned 1
        1:   63:    inc_ref(obj);
call    0 returned 1
        -:   64:
        1:   65:    defer_decrement(obj);
call    0 returned 1
        1:   66:    int count_after_first = DEFERRED_CTX.pending_count;
        -:   67:
        1:   68:    defer_decrement(obj);  /* Should coalesce */
call    0 returned 1
       1*:   69:    ASSERT_EQ(DEFERRED_CTX.pending_count, count_after_first);  /* Same entry */
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        -:   70:
        1:   71:    flush_deferred();
call    0 returned 1
        1:   72:    dec_ref(obj);
call    0 returned 1
        1:   73:    PASS();
call    0 returned 1
        -:   74:}
        -:   75:
function test_defer_decrement_multiple_objs called 1 returned 100% blocks executed 89%
        1:   76:void test_defer_decrement_multiple_objs(void) {
        1:   77:    flush_deferred();
call    0 returned 1
        1:   78:    Obj* obj1 = mk_int(1);
call    0 returned 1
        1:   79:    Obj* obj2 = mk_int(2);
call    0 returned 1
        1:   80:    Obj* obj3 = mk_int(3);
call    0 returned 1
        1:   81:    inc_ref(obj1);
call    0 returned 1
        1:   82:    inc_ref(obj2);
call    0 returned 1
        1:   83:    inc_ref(obj3);
call    0 returned 1
        -:   84:
        1:   85:    defer_decrement(obj1);
call    0 returned 1
        1:   86:    defer_decrement(obj2);
call    0 returned 1
        1:   87:    defer_decrement(obj3);
call    0 returned 1
        -:   88:
       1*:   89:    ASSERT(DEFERRED_CTX.pending_count >= 3);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        -:   90:
        1:   91:    flush_deferred();
call    0 returned 1
        1:   92:    dec_ref(obj1);
call    0 returned 1
        1:   93:    dec_ref(obj2);
call    0 returned 1
        1:   94:    dec_ref(obj3);
call    0 returned 1
        1:   95:    PASS();
call    0 returned 1
        -:   96:}
        -:   97:
        -:   98:/* ========== process_deferred Tests ========== */
        -:   99:
function test_process_deferred_empty called 1 returned 100% blocks executed 62%
        1:  100:void test_process_deferred_empty(void) {
        1:  101:    flush_deferred();
call    0 returned 1
        1:  102:    process_deferred();  /* Should not crash */
call    0 returned 1
       1*:  103:    ASSERT_EQ(DEFERRED_CTX.pending_count, 0);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        1:  104:    PASS();
call    0 returned 1
        -:  105:}
        -:  106:
function test_process_deferred_single called 1 returned 100% blocks executed 77%
        1:  107:void test_process_deferred_single(void) {
        1:  108:    flush_deferred();
call    0 returned 1
        1:  109:    Obj* obj = mk_int(42);
call    0 returned 1
        1:  110:    inc_ref(obj);  /* ref=2 */
call    0 returned 1
        1:  111:    defer_decrement(obj);
call    0 returned 1
        -:  112:
        1:  113:    set_deferred_batch_size(10);
call    0 returned 1
        1:  114:    process_deferred();
call    0 returned 1
        -:  115:
       1*:  116:    ASSERT_EQ(DEFERRED_CTX.pending_count, 0);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        1:  117:    dec_ref(obj);  /* Clean up */
call    0 returned 1
        1:  118:    PASS();
call    0 returned 1
        -:  119:}
        -:  120:
function test_process_deferred_bounded called 1 returned 100% blocks executed 86%
        1:  121:void test_process_deferred_bounded(void) {
        1:  122:    flush_deferred();
call    0 returned 1
        1:  123:    set_deferred_batch_size(5);
call    0 returned 1
        -:  124:
        -:  125:    /* Create 20 deferred decrements */
        -:  126:    Obj* objs[20];
       21:  127:    for (int i = 0; i < 20; i++) {
branch  0 taken 20
branch  1 taken 1 (fallthrough)
       20:  128:        objs[i] = mk_int(i);
call    0 returned 20
       20:  129:        inc_ref(objs[i]);
call    0 returned 20
       20:  130:        defer_decrement(objs[i]);
call    0 returned 20
        -:  131:    }
        -:  132:
        1:  133:    int before = DEFERRED_CTX.pending_count;
        1:  134:    process_deferred();  /* Should process at most 5 */
call    0 returned 1
        1:  135:    int after = DEFERRED_CTX.pending_count;
        -:  136:
       1*:  137:    ASSERT(before - after <= 5);  /* Bounded processing */
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        -:  138:
        1:  139:    flush_deferred();
call    0 returned 1
       21:  140:    for (int i = 0; i < 20; i++) {
branch  0 taken 20
branch  1 taken 1 (fallthrough)
       20:  141:        dec_ref(objs[i]);
call    0 returned 20
        -:  142:    }
        1:  143:    PASS();
call    0 returned 1
        -:  144:}
        -:  145:
        -:  146:/* ========== flush_deferred Tests ========== */
        -:  147:
function test_flush_deferred_empty called 1 returned 100% blocks executed 57%
        1:  148:void test_flush_deferred_empty(void) {
        1:  149:    flush_deferred();
call    0 returned 1
       1*:  150:    ASSERT_EQ(DEFERRED_CTX.pending_count, 0);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        1:  151:    PASS();
call    0 returned 1
        -:  152:}
        -:  153:
function test_flush_deferred_all called 1 returned 100% blocks executed 68%
        1:  154:void test_flush_deferred_all(void) {
        -:  155:    Obj* objs[10];
       11:  156:    for (int i = 0; i < 10; i++) {
branch  0 taken 10
branch  1 taken 1 (fallthrough)
       10:  157:        objs[i] = mk_int(i);
call    0 returned 10
       10:  158:        inc_ref(objs[i]);
call    0 returned 10
       10:  159:        defer_decrement(objs[i]);
call    0 returned 10
        -:  160:    }
        -:  161:
       1*:  162:    ASSERT(DEFERRED_CTX.pending_count > 0);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        -:  163:
        1:  164:    flush_deferred();
call    0 returned 1
        -:  165:
       1*:  166:    ASSERT_EQ(DEFERRED_CTX.pending_count, 0);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
       1*:  167:    ASSERT_NULL(DEFERRED_CTX.pending);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        -:  168:
       11:  169:    for (int i = 0; i < 10; i++) {
branch  0 taken 10
branch  1 taken 1 (fallthrough)
       10:  170:        dec_ref(objs[i]);
call    0 returned 10
        -:  171:    }
        1:  172:    PASS();
call    0 returned 1
        -:  173:}
        -:  174:
        -:  175:/* ========== should_process_deferred Tests ========== */
        -:  176:
function test_should_process_deferred_low called 1 returned 100% blocks executed 85%
        1:  177:void test_should_process_deferred_low(void) {
        1:  178:    flush_deferred();
call    0 returned 1
        1:  179:    set_deferred_batch_size(100);
call    0 returned 1
        -:  180:
        -:  181:    /* Add a few items */
        1:  182:    Obj* obj = mk_int(42);
call    0 returned 1
        1:  183:    inc_ref(obj);
call    0 returned 1
        1:  184:    defer_decrement(obj);
call    0 returned 1
        -:  185:
       1*:  186:    ASSERT(!should_process_deferred());  /* Not enough pending */
call    0 returned 1
branch  1 taken 0 (fallthrough)
branch  2 taken 1
call    3 never executed
        -:  187:
        1:  188:    flush_deferred();
call    0 returned 1
        1:  189:    dec_ref(obj);
call    0 returned 1
        1:  190:    PASS();
call    0 returned 1
        -:  191:}
        -:  192:
function test_should_process_deferred_high called 1 returned 100% blocks executed 86%
        1:  193:void test_should_process_deferred_high(void) {
        1:  194:    flush_deferred();
call    0 returned 1
        1:  195:    set_deferred_batch_size(5);
call    0 returned 1
        -:  196:
        -:  197:    /* Add many items to exceed threshold */
        -:  198:    Obj* objs[20];
       21:  199:    for (int i = 0; i < 20; i++) {
branch  0 taken 20
branch  1 taken 1 (fallthrough)
       20:  200:        objs[i] = mk_int(i);
call    0 returned 20
       20:  201:        inc_ref(objs[i]);
call    0 returned 20
       20:  202:        defer_decrement(objs[i]);
call    0 returned 20
        -:  203:    }
        -:  204:
       1*:  205:    ASSERT(should_process_deferred());  /* Exceeds threshold */
call    0 returned 1
branch  1 taken 0 (fallthrough)
branch  2 taken 1
call    3 never executed
        -:  206:
        1:  207:    flush_deferred();
call    0 returned 1
       21:  208:    for (int i = 0; i < 20; i++) {
branch  0 taken 20
branch  1 taken 1 (fallthrough)
       20:  209:        dec_ref(objs[i]);
call    0 returned 20
        -:  210:    }
        1:  211:    PASS();
call    0 returned 1
        -:  212:}
        -:  213:
        -:  214:/* ========== safe_point Tests ========== */
        -:  215:
function test_safe_point_no_pending called 1 returned 100% blocks executed 100%
        1:  216:void test_safe_point_no_pending(void) {
        1:  217:    flush_deferred();
call    0 returned 1
        1:  218:    safe_point();  /* Should not crash */
call    0 returned 1
        1:  219:    PASS();
call    0 returned 1
        1:  220:}
        -:  221:
function test_safe_point_low_pending called 1 returned 100% blocks executed 79%
        1:  222:void test_safe_point_low_pending(void) {
        1:  223:    flush_deferred();
call    0 returned 1
        1:  224:    set_deferred_batch_size(100);
call    0 returned 1
        -:  225:
        1:  226:    Obj* obj = mk_int(42);
call    0 returned 1
        1:  227:    inc_ref(obj);
call    0 returned 1
        1:  228:    defer_decrement(obj);
call    0 returned 1
        -:  229:
        1:  230:    int count = DEFERRED_CTX.pending_count;
        1:  231:    safe_point();
call    0 returned 1
       1*:  232:    ASSERT_EQ(DEFERRED_CTX.pending_count, count);  /* Unchanged */
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        -:  233:
        1:  234:    flush_deferred();
call    0 returned 1
        1:  235:    dec_ref(obj);
call    0 returned 1
        1:  236:    PASS();
call    0 returned 1
        -:  237:}
        -:  238:
function test_safe_point_triggers_processing called 1 returned 100% blocks executed 86%
        1:  239:void test_safe_point_triggers_processing(void) {
        1:  240:    flush_deferred();
call    0 returned 1
        1:  241:    set_deferred_batch_size(5);
call    0 returned 1
        -:  242:
        -:  243:    Obj* objs[30];
       31:  244:    for (int i = 0; i < 30; i++) {
branch  0 taken 30
branch  1 taken 1 (fallthrough)
       30:  245:        objs[i] = mk_int(i);
call    0 returned 30
       30:  246:        inc_ref(objs[i]);
call    0 returned 30
       30:  247:        defer_decrement(objs[i]);
call    0 returned 30
        -:  248:    }
        -:  249:
        1:  250:    int before = DEFERRED_CTX.pending_count;
        1:  251:    safe_point();  /* Should trigger processing */
call    0 returned 1
        1:  252:    int after = DEFERRED_CTX.pending_count;
        -:  253:
       1*:  254:    ASSERT(after < before);  /* Some processed */
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        -:  255:
        1:  256:    flush_deferred();
call    0 returned 1
       31:  257:    for (int i = 0; i < 30; i++) {
branch  0 taken 30
branch  1 taken 1 (fallthrough)
       30:  258:        dec_ref(objs[i]);
call    0 returned 30
        -:  259:    }
        1:  260:    PASS();
call    0 returned 1
        -:  261:}
        -:  262:
        -:  263:/* ========== Integration Tests ========== */
        -:  264:
function test_deferred_with_dec_ref called 1 returned 100% blocks executed 78%
        1:  265:void test_deferred_with_dec_ref(void) {
        1:  266:    flush_deferred();
call    0 returned 1
        -:  267:
        1:  268:    Obj* obj = mk_int(42);
call    0 returned 1
        -:  269:    /* obj has ref=1 */
        -:  270:
        -:  271:    /* Defer instead of immediate dec_ref */
        1:  272:    defer_decrement(obj);
call    0 returned 1
        -:  273:
        -:  274:    /* Object should still exist (deferred) */
       1*:  275:    ASSERT(DEFERRED_CTX.pending_count > 0);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        -:  276:
        -:  277:    /* Flush to actually free */
        1:  278:    flush_deferred();
call    0 returned 1
        1:  279:    PASS();
call    0 returned 1
        -:  280:}
        -:  281:
function test_deferred_total_counter called 1 returned 100% blocks executed 81%
        1:  282:void test_deferred_total_counter(void) {
        1:  283:    flush_deferred();
call    0 returned 1
        1:  284:    int old_total = DEFERRED_CTX.total_deferred;
        -:  285:
        1:  286:    Obj* obj = mk_int(42);
call    0 returned 1
        -:  287:    /* Need 4 refs: 1 original + 3 for deferred decrements + 1 for final dec_ref */
        1:  288:    inc_ref(obj);  /* ref=2 */
call    0 returned 1
        1:  289:    inc_ref(obj);  /* ref=3 */
call    0 returned 1
        1:  290:    inc_ref(obj);  /* ref=4 */
call    0 returned 1
        1:  291:    defer_decrement(obj);  /* will dec to 3 */
call    0 returned 1
        1:  292:    defer_decrement(obj);  /* will dec to 2 */
call    0 returned 1
        1:  293:    defer_decrement(obj);  /* will dec to 1 */
call    0 returned 1
        -:  294:
       1*:  295:    ASSERT_EQ(DEFERRED_CTX.total_deferred, old_total + 3);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        -:  296:
        1:  297:    flush_deferred();  /* ref: 4→3→2→1 */
call    0 returned 1
        1:  298:    dec_ref(obj);      /* ref: 1→0, freed */
call    0 returned 1
        1:  299:    PASS();
call    0 returned 1
        -:  300:}
        -:  301:
        -:  302:/* ========== Stress Tests ========== */
        -:  303:
function test_deferred_stress_many_objects called 1 returned 100% blocks executed 86%
        1:  304:void test_deferred_stress_many_objects(void) {
        1:  305:    flush_deferred();
call    0 returned 1
        1:  306:    set_deferred_batch_size(50);
call    0 returned 1
        -:  307:
        -:  308:    Obj* objs[500];
      501:  309:    for (int i = 0; i < 500; i++) {
branch  0 taken 500
branch  1 taken 1 (fallthrough)
      500:  310:        objs[i] = mk_int(i);
call    0 returned 500
      500:  311:        inc_ref(objs[i]);  /* ref=2, one for us, one for deferred */
call    0 returned 500
      500:  312:        defer_decrement(objs[i]);
call    0 returned 500
        -:  313:    }
        -:  314:
        -:  315:    /* Process in batches */
       11:  316:    while (DEFERRED_CTX.pending_count > 0) {
branch  0 taken 10
branch  1 taken 1 (fallthrough)
       10:  317:        process_deferred();
call    0 returned 10
        -:  318:    }
        -:  319:
       1*:  320:    ASSERT_EQ(DEFERRED_CTX.pending_count, 0);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        -:  321:
      501:  322:    for (int i = 0; i < 500; i++) {
branch  0 taken 500
branch  1 taken 1 (fallthrough)
      500:  323:        dec_ref(objs[i]);  /* ref: 1→0, freed */
call    0 returned 500
        -:  324:    }
        1:  325:    PASS();
call    0 returned 1
        -:  326:}
        -:  327:
function test_deferred_stress_flush_cycle called 1 returned 100% blocks executed 79%
        1:  328:void test_deferred_stress_flush_cycle(void) {
      101:  329:    for (int round = 0; round < 100; round++) {
branch  0 taken 100
branch  1 taken 1 (fallthrough)
      100:  330:        Obj* obj = mk_int(round);
call    0 returned 100
      100:  331:        inc_ref(obj);
call    0 returned 100
      100:  332:        defer_decrement(obj);
call    0 returned 100
      100:  333:        flush_deferred();
call    0 returned 100
      100:  334:        dec_ref(obj);
call    0 returned 100
        -:  335:    }
       1*:  336:    ASSERT_EQ(DEFERRED_CTX.pending_count, 0);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        1:  337:    PASS();
call    0 returned 1
        -:  338:}
        -:  339:
function test_deferred_stress_safe_points called 1 returned 100% blocks executed 100%
        1:  340:void test_deferred_stress_safe_points(void) {
        1:  341:    set_deferred_batch_size(10);
call    0 returned 1
        -:  342:
     1001:  343:    for (int i = 0; i < 1000; i++) {
branch  0 taken 1000
branch  1 taken 1 (fallthrough)
     1000:  344:        Obj* obj = mk_int(i);
call    0 returned 1000
     1000:  345:        inc_ref(obj);
call    0 returned 1000
     1000:  346:        defer_decrement(obj);
call    0 returned 1000
        -:  347:
        -:  348:        /* Periodic safe points */
     1000:  349:        if (i % 100 == 0) {
branch  0 taken 10 (fallthrough)
branch  1 taken 990
       10:  350:            safe_point();
call    0 returned 10
        -:  351:        }
        -:  352:    }
        -:  353:
        1:  354:    flush_deferred();
call    0 returned 1
        1:  355:    PASS();
call    0 returned 1
        1:  356:}
        -:  357:
        -:  358:/* ========== Edge Cases ========== */
        -:  359:
function test_deferred_coalesce_many called 1 returned 100% blocks executed 88%
        1:  360:void test_deferred_coalesce_many(void) {
        1:  361:    flush_deferred();
call    0 returned 1
        1:  362:    Obj* obj = mk_int(42);
call    0 returned 1
        -:  363:
        -:  364:    /* Add many refs then defer many decrements */
      101:  365:    for (int i = 0; i < 100; i++) {
branch  0 taken 100
branch  1 taken 1 (fallthrough)
      100:  366:        inc_ref(obj);
call    0 returned 100
        -:  367:    }
        -:  368:
      101:  369:    for (int i = 0; i < 100; i++) {
branch  0 taken 100
branch  1 taken 1 (fallthrough)
      100:  370:        defer_decrement(obj);
call    0 returned 100
        -:  371:    }
        -:  372:
        -:  373:    /* Should have coalesced into fewer entries */
       1*:  374:    ASSERT(DEFERRED_CTX.pending_count < 100);
branch  0 taken 0 (fallthrough)
branch  1 taken 1
call    2 never executed
        -:  375:
        1:  376:    flush_deferred();
call    0 returned 1
        1:  377:    dec_ref(obj);  /* Final ref */
call    0 returned 1
        1:  378:    PASS();
call    0 returned 1
        -:  379:}
        -:  380:
function test_deferred_interleaved_process called 1 returned 100% blocks executed 100%
        1:  381:void test_deferred_interleaved_process(void) {
        1:  382:    flush_deferred();
call    0 returned 1
        1:  383:    set_deferred_batch_size(5);
call    0 returned 1
        -:  384:
       11:  385:    for (int round = 0; round < 10; round++) {
branch  0 taken 10
branch  1 taken 1 (fallthrough)
        -:  386:        /* Add some */
      110:  387:        for (int i = 0; i < 10; i++) {
branch  0 taken 100
branch  1 taken 10 (fallthrough)
      100:  388:            Obj* obj = mk_int(round * 10 + i);
call    0 returned 100
      100:  389:            inc_ref(obj);
call    0 returned 100
      100:  390:            defer_decrement(obj);
call    0 returned 100
      100:  391:            dec_ref(obj);
call    0 returned 100
        -:  392:        }
        -:  393:        /* Process some */
       10:  394:        process_deferred();
call    0 returned 10
        -:  395:    }
        -:  396:
        1:  397:    flush_deferred();
call    0 returned 1
        1:  398:    PASS();
call    0 returned 1
        1:  399:}
        -:  400:
        -:  401:/* ========== Run All Deferred Tests ========== */
        -:  402:
function run_deferred_tests called 1 returned 100% blocks executed 63%
        1:  403:void run_deferred_tests(void) {
        1:  404:    TEST_SUITE("Deferred Reference Counting");
call    0 returned 1
        -:  405:
        1:  406:    TEST_SECTION("Context");
call    0 returned 1
       1*:  407:    RUN_TEST(test_deferred_ctx_initial);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
       1*:  408:    RUN_TEST(test_set_deferred_batch_size);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
       1*:  409:    RUN_TEST(test_set_deferred_batch_size_zero);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
       1*:  410:    RUN_TEST(test_set_deferred_batch_size_negative);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
        -:  411:
        1:  412:    TEST_SECTION("defer_decrement");
call    0 returned 1
       1*:  413:    RUN_TEST(test_defer_decrement_single);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
       1*:  414:    RUN_TEST(test_defer_decrement_null);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
       1*:  415:    RUN_TEST(test_deferred_coalesce_same_obj);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
       1*:  416:    RUN_TEST(test_defer_decrement_multiple_objs);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
        -:  417:
        1:  418:    TEST_SECTION("process_deferred");
call    0 returned 1
       1*:  419:    RUN_TEST(test_process_deferred_empty);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
       1*:  420:    RUN_TEST(test_process_deferred_single);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
       1*:  421:    RUN_TEST(test_process_deferred_bounded);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
        -:  422:
        1:  423:    TEST_SECTION("flush_deferred");
call    0 returned 1
       1*:  424:    RUN_TEST(test_flush_deferred_empty);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
       1*:  425:    RUN_TEST(test_flush_deferred_all);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
        -:  426:
        1:  427:    TEST_SECTION("should_process_deferred");
call    0 returned 1
       1*:  428:    RUN_TEST(test_should_process_deferred_low);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
       1*:  429:    RUN_TEST(test_should_process_deferred_high);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
        -:  430:
        1:  431:    TEST_SECTION("safe_point");
call    0 returned 1
       1*:  432:    RUN_TEST(test_safe_point_no_pending);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
       1*:  433:    RUN_TEST(test_safe_point_low_pending);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
       1*:  434:    RUN_TEST(test_safe_point_triggers_processing);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
        -:  435:
        1:  436:    TEST_SECTION("Integration");
call    0 returned 1
       1*:  437:    RUN_TEST(test_deferred_with_dec_ref);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
       1*:  438:    RUN_TEST(test_deferred_total_counter);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
        -:  439:
        1:  440:    TEST_SECTION("Stress Tests");
call    0 returned 1
       1*:  441:    RUN_TEST(test_deferred_stress_many_objects);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
       1*:  442:    RUN_TEST(test_deferred_stress_flush_cycle);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
       1*:  443:    RUN_TEST(test_deferred_stress_safe_points);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
        -:  444:
        1:  445:    TEST_SECTION("Edge Cases");
call    0 returned 1
       1*:  446:    RUN_TEST(test_deferred_coalesce_many);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
       1*:  447:    RUN_TEST(test_deferred_interleaved_process);
call    0 returned 1
call    1 returned 1
branch  2 taken 0 (fallthrough)
branch  3 taken 1
branch  4 never executed (fallthrough)
branch  5 never executed
call    6 never executed
        1:  448:}
